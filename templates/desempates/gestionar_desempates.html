{% extends "base.html" %}

{% block title %}Gestión de Desempates{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">Gestión de Criterios de Desempate</h1>
            
            {% if mensaje %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ mensaje }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            <!-- Tabs para navegación -->
            <ul class="nav nav-tabs" id="desempateTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="automatico-tab" data-bs-toggle="tab" 
                            data-bs-target="#automatico" type="button" role="tab">
                        Criterios Automáticos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" 
                            data-bs-target="#manual" type="button" role="tab">
                        Cambios Manuales
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="desempateTabContent">
                <!-- TAB: Criterios Automáticos -->
                <div class="tab-pane fade show active" id="automatico" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title">Criterios de Desempate Automáticos por Segmento</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Segmento</th>
                                            <th>Criterio Actual</th>
                                            <th>Cambiar a</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="criterios-tbody">
                                        <!-- Se cargará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Explicación de opciones -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="card-title">Opciones de Desempate Disponibles</h6>
                        </div>
                        <div class="card-body">
                            <div id="opciones-container"></div>
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Cambios Manuales -->
                <div class="tab-pane fade" id="manual" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title">Ordenamiento Manual de Postulantes</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="segmento-select" class="form-label">Seleccionar Segmento:</label>
                                    <select class="form-select" id="segmento-select">
                                        <option value="">-- Seleccione un segmento --</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="pt-4">
                                        <button class="btn btn-danger" id="resetear-btn" onclick="resetearOrdenamiento()">
                                            Resetear Cambios Manuales
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="cambios-manuales-container" style="display:none;">
                                <div class="alert alert-info">
                                    <h6>Cambios Manuales Actuales:</h6>
                                    <div id="cambios-lista"></div>
                                </div>
                                
                                <hr>
                                
                                <div>
                                    <h6>Agregar Nuevo Cambio Manual:</h6>
                                    <form id="form-cambio-manual">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label for="postulante-id-input" class="form-label">ID Postulante:</label>
                                                <input type="text" class="form-control" id="postulante-id-input" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="posicion-input" class="form-label">Posición (0 = primero):</label>
                                                <input type="number" class="form-control" id="posicion-input" min="0" required>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="pt-4">
                                                    <button type="submit" class="btn btn-primary w-100">
                                                        Agregar Cambio
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globales
    const segmentoSeleccionado = null;
    
    // Cargar datos al inicializar
    document.addEventListener('DOMContentLoaded', function() {
        cargarCriterios();
        cargarOpciones();
        cargarSegmentosSelect();
    });
    
    // Cargar todos los criterios
    async function cargarCriterios() {
        try {
            const response = await fetch('/api/desempate/criterios');
            const data = await response.json();
            
            if (data.success) {
                mostrarCriterios(data.criterios);
            }
        } catch (error) {
            console.error('Error al cargar criterios:', error);
        }
    }
    
    // Mostrar criterios en la tabla
    function mostrarCriterios(criterios) {
        const tbody = document.getElementById('criterios-tbody');
        tbody.innerHTML = '';
        
        for (const [segmento, datos] of Object.entries(criterios)) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${segmento}</strong></td>
                <td>
                    <span class="badge bg-info">${datos.tipo}</span>
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="cambiarCriterio('${segmento}', this.value)">
                        <option value="">-- Seleccione --</option>
                        <option value="alfabetico_apellido">Alfabético Apellido</option>
                        <option value="alfabetico_nombre">Alfabético Nombre</option>
                        <option value="mayor_edad">Mayor Edad</option>
                        <option value="menor_edad">Menor Edad</option>
                        <option value="fecha_inscripcion">Fecha Inscripción</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="verDetalles('${encodeURIComponent(segmento)}')">
                        Ver Cambios Manuales
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        }
    }
    
    // Cargar opciones de desempate
    async function cargarOpciones() {
        try {
            const response = await fetch('/api/desempate/opciones');
            const data = await response.json();
            
            if (data.success) {
                mostrarOpciones(data.opciones);
            }
        } catch (error) {
            console.error('Error al cargar opciones:', error);
        }
    }
    
    // Mostrar opciones de desempate
    function mostrarOpciones(opciones) {
        const container = document.getElementById('opciones-container');
        container.innerHTML = '';
        
        opciones.forEach(opcion => {
            const div = document.createElement('div');
            div.className = 'mb-3 p-2 border rounded';
            div.innerHTML = `
                <strong>${opcion.etiqueta}:</strong> ${opcion.descripcion}
            `;
            container.appendChild(div);
        });
    }
    
    // Cargar segmentos en el select
    async function cargarSegmentosSelect() {
        try {
            const response = await fetch('/api/desempate/criterios');
            const data = await response.json();
            
            if (data.success) {
                const select = document.getElementById('segmento-select');
                for (const segmento of Object.keys(data.criterios)) {
                    const option = document.createElement('option');
                    option.value = segmento;
                    option.textContent = segmento;
                    select.appendChild(option);
                }
                
                // Agregar evento change
                select.addEventListener('change', function() {
                    if (this.value) {
                        cargarCambiosManuales(this.value);
                    } else {
                        document.getElementById('cambios-manuales-container').style.display = 'none';
                    }
                });
            }
        } catch (error) {
            console.error('Error al cargar segmentos:', error);
        }
    }
    
    // Cambiar criterio de desempate
    async function cambiarCriterio(segmento, tipo) {
        if (!tipo) return;
        
        try {
            const response = await fetch(`/api/desempate/criterio/${segmento}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tipo_desempate: tipo })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Criterio actualizado exitosamente');
                cargarCriterios();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al actualizar criterio');
        }
    }
    
    // Cargar cambios manuales
    async function cargarCambiosManuales(segmento) {
        try {
            const response = await fetch(`/api/desempate/criterio/${segmento}`);
            const data = await response.json();
            
            if (data.success) {
                mostrarCambiosManuales(data.criterio.cambios_manuales);
                document.getElementById('cambios-manuales-container').style.display = 'block';
            }
        } catch (error) {
            console.error('Error al cargar cambios manuales:', error);
        }
    }
    
    // Mostrar cambios manuales
    function mostrarCambiosManuales(cambios) {
        const lista = document.getElementById('cambios-lista');
        
        if (Object.keys(cambios).length === 0) {
            lista.innerHTML = '<p class="text-muted">No hay cambios manuales configurados</p>';
        } else {
            lista.innerHTML = '<ul>';
            for (const [postulante, posicion] of Object.entries(cambios)) {
                lista.innerHTML += `
                    <li>
                        Postulante ${postulante} → Posición ${posicion}
                        <button class="btn btn-sm btn-danger" onclick="removerCambioManual('${postulante}')">
                            Remover
                        </button>
                    </li>
                `;
            }
            lista.innerHTML += '</ul>';
        }
    }
    
    // Agregar cambio manual
    document.getElementById('form-cambio-manual')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const segmento = document.getElementById('segmento-select').value;
        const postulanteId = document.getElementById('postulante-id-input').value;
        const posicion = parseInt(document.getElementById('posicion-input').value);
        
        try {
            const response = await fetch(`/api/desempate/cambio-manual/${segmento}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postulante_id: postulanteId,
                    posicion: posicion
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Cambio manual agregado exitosamente');
                document.getElementById('form-cambio-manual').reset();
                cargarCambiosManuales(segmento);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al agregar cambio manual');
        }
    });
    
    // Remover cambio manual
    async function removerCambioManual(postulanteId) {
        const segmento = document.getElementById('segmento-select').value;
        
        try {
            const response = await fetch(`/api/desempate/cambio-manual/${segmento}/${postulanteId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Cambio manual removido');
                cargarCambiosManuales(segmento);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al remover cambio manual');
        }
    }
    
    // Resetear ordenamiento
    async function resetearOrdenamiento() {
        const segmento = document.getElementById('segmento-select').value;
        
        if (!segmento) {
            alert('Seleccione un segmento primero');
            return;
        }
        
        if (!confirm('¿Está seguro de que desea resetear todos los cambios manuales para este segmento?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/desempate/resetear/${segmento}`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Cambios manuales reseteados');
                cargarCambiosManuales(segmento);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al resetear');
        }
    }
    
    // Ver detalles
    function verDetalles(segmento) {
        // Decodificar el segmento por si viene codificado
        try {
            segmento = decodeURIComponent(segmento);
        } catch (e) {
            console.log("No fue necesario decodificar");
        }
        
        const select = document.getElementById('segmento-select');
        select.value = segmento;
        
        // Forzar el evento change para actualizar los cambios manuales
        select.dispatchEvent(new Event('change'));
        
        // Cambiar a la tab de cambios manuales
        document.getElementById('manual-tab').click();
    }
</script>

<style>
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .badge {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .form-select-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}
