{% extends "base.html" %}

{% block title %}Gestión de Desempates{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">Gestión de Criterios de Desempate</h1>
            
            {% if mensaje %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ mensaje }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="card-title">Criterios de Desempate por Segmento</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Segmento</th>
                                    <th>Criterio Actual</th>
                                    <th>Cambiar a</th>
                                </tr>
                            </thead>
                            <tbody id="criterios-tbody">
                                <!-- Se cargará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variables globales
    const segmentoSeleccionado = null;
    
    // Cargar datos al inicializar
    document.addEventListener('DOMContentLoaded', function() {
        cargarCriterios();
        cargarOpciones();
    });
    
    // Cargar todos los criterios
    async function cargarCriterios() {
        try {
            const response = await fetch('/api/desempate/criterios');
            const data = await response.json();
            
            if (data.success) {
                mostrarCriterios(data.criterios);
            }
        } catch (error) {
            console.error('Error al cargar criterios:', error);
        }
    }
    
    // Mostrar criterios en la tabla
    function mostrarCriterios(criterios) {
        const tbody = document.getElementById('criterios-tbody');
        tbody.innerHTML = '';
        
        for (const [segmento, datos] of Object.entries(criterios)) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${segmento}</strong></td>
                <td>
                    <span class="badge bg-info">${datos.tipo}</span>
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="cambiarCriterio('${segmento}', this.value)">
                        <option value="">-- Seleccione --</option>
                        <option value="alfabetico_apellido">Alfabético Apellido</option>
                        <option value="alfabetico_nombre">Alfabético Nombre</option>
                        <option value="mayor_edad">Mayor Edad</option>
                        <option value="menor_edad">Menor Edad</option>
                        <option value="fecha_inscripcion">Fecha Inscripción</option>
                    </select>
                </td>
            `;
            tbody.appendChild(row);
        }
    }
    
    // Cargar opciones de desempate
    async function cargarOpciones() {
        try {
            const response = await fetch('/api/desempate/opciones');
            const data = await response.json();
            
            if (data.success) {
                mostrarOpciones(data.opciones);
            }
        } catch (error) {
            console.error('Error al cargar opciones:', error);
        }
    }
    
    // Mostrar opciones de desempate
    function mostrarOpciones(opciones) {
        const container = document.getElementById('opciones-container');
        container.innerHTML = '';
        
        opciones.forEach(opcion => {
            const div = document.createElement('div');
            div.className = 'mb-3 p-2 border rounded';
            div.innerHTML = `
                <strong>${opcion.etiqueta}:</strong> ${opcion.descripcion}
            `;
            container.appendChild(div);
        });
    }
    
    // Cambiar criterio de desempate
    async function cambiarCriterio(segmento, tipo) {
        if (!tipo) return;
        
        try {
            const response = await fetch(`/api/desempate/criterio/${segmento}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tipo_desempate: tipo })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Criterio actualizado exitosamente');
                cargarCriterios();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al actualizar criterio');
        }
    }
</script>

<style>
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .badge {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .form-select-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}
